// {{name}} enum
type {{name}}Variant interface {
    is{{name}}()
}

type {{name}} struct {
    {{name}}Variant
}

type {{name}}Deserializer struct {
   Inner {{name}}
}

func (result *{{name}}) UnmarshalJSON(b []byte) error {
    var deserializer {{name}}Deserializer
    err := json.Unmarshal(b, &deserializer)
    if err != nil {
        return err
    }
    *result = deserializer.Inner
    return nil
}

func (result *{{name}}Deserializer) UnmarshalJSON(b []byte) error {
    var variantName string
    var variantValue *json.RawMessage

    // try and deserialize as a string first
    err := json.Unmarshal(b, &variantName)
    if err != nil { 
        var rawMap map[string]json.RawMessage
        err := json.Unmarshal(b, &rawMap)
        if err != nil {
            return err
        }
         // JSON should be of form {"VariantName": {...}}
        if len(rawMap) != 1 {
            return errors.New("deserializing {{name}} as an enum variant; expecting a single key")
        }
        for k, v := range rawMap {
            variantName = k
            variantValue = &v
        }
    }
    switch variantName {
    {{#each variants}}
    case "{{this.name}}":
        var variant {{../name}}{{this.name}}
        if variantValue != nil {
            err := json.Unmarshal(*variantValue, &variant);
            if err != nil {
                return err
            }
        }
        *result = {{../name}}Deserializer { Inner: {{../name}} { variant } }
        return nil
    {{/each}}
    }

    return fmt.Errorf("cannot deserialize {{../name}}: %s", string(b))
}


func (variant {{name}}) MarshalJSON() ([]byte, error) {
    switch inner := variant.{{name}}Variant.(type) {
    {{#each variants}}
    case {{../name}}{{this.name}}:
        {{#if (eq this.variant "UNIT")}}
        return json.Marshal("{{this.name}}")
        {{else}}
        return json.Marshal(map[string]{{../name}}{{this.name}} {
            "{{this.name}}": inner,
        });
        {{/if}}
    {{/each}}
    default:
        return nil, fmt.Errorf("unexpected variant %#v of %v", inner, variant)
    }

}
